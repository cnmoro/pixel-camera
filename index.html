<!DOCTYPE html>
<html>

<head>
  <title>Real-Time Pixel Camera</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #000;
    }

    #controls {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px;
      color: white;
      z-index: 100;
    }

    #outputCanvas {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100vw;
      height: 100vh;
      object-fit: cover;
    }
  </style>
</head>

<body>
  <div id="controls">
    <select id="cameraSelect"></select>
    <select id="paletteSelect"></select>
    <div>
      <label>Pixel Scale: <input type="range" id="pixelSize" min="4" max="32" value="8"></label>
    </div>
    <div>
      <label>Brightness: <input type="range" id="brightness" min="0" max="2" step="0.1" value="1"></label>
    </div>
    <div>
      <label>Contrast: <input type="range" id="contrast" min="0" max="2" step="0.1" value="1"></label>
    </div>
    <div>
      <label>Soft Focus: <input type="checkbox" id="softFocusToggle"></label>
    </div>
    <button id="captureButton">Take Picture</button>
  </div>
  <canvas id="outputCanvas"></canvas>

  <script>
    const palettes = {
      'digital-paper': [[245, 245, 245], [145, 163, 170], [76, 86, 113], [5, 5, 5]],
      'eulbink': [[255, 255, 255], [12, 230, 242], [0, 152, 219], [30, 87, 156], [32, 53, 98], [37, 36, 70], [32, 21, 51]],
      'human16': [[204, 121, 167], [213, 94, 0], [230, 159, 0], [240, 228, 66], [0, 158, 115], [86, 180, 233], [0, 114, 178], [101, 77, 115], [0, 0, 0], [174, 179, 184], [255, 255, 255], [43, 35, 28], [76, 52, 42], [143, 109, 69], [175, 146, 113], [228, 208, 181]],
      'ice-cream-gb': [[124, 63, 88], [235, 107, 111], [249, 168, 117], [255, 246, 211]],
      'lava-gb': [[5, 31, 57], [74, 36, 128], [197, 58, 157], [255, 142, 128]],
      'midnight-ablaze': [[255, 130, 116], [213, 60, 106], [124, 24, 60], [70, 14, 43], [49, 5, 30], [31, 5, 16], [19, 2, 8]],
      'oil-6': [[251, 245, 239], [242, 211, 171], [198, 159, 165], [139, 109, 156], [73, 77, 126], [39, 39, 68]],
      'rust-gold-8': [[246, 205, 38], [172, 107, 38], [86, 50, 38], [51, 28, 23], [187, 127, 87], [114, 89, 86], [57, 57, 57], [32, 32, 32]],
      'simple-feudal-japanese': [[250, 251, 255], [242, 219, 188], [219, 199, 169], [92, 85, 75], [35, 35, 31], [23, 23, 22], [5, 5, 5], [229, 177, 198], [216, 142, 180], [193, 132, 151], [170, 109, 125], [186, 67, 71], [117, 44, 34], [90, 35, 34], [247, 226, 136], [223, 192, 128], [225, 195, 78], [224, 192, 8], [162, 169, 115], [113, 112, 100], [47, 117, 88], [33, 115, 63], [34, 65, 50], [148, 169, 232], [101, 111, 168], [81, 97, 165], [68, 82, 153], [35, 69, 121], [17, 41, 91], [28, 34, 66]],
      'slso8': [[13, 43, 69], [32, 60, 86], [84, 78, 104], [141, 105, 122], [208, 129, 89], [255, 170, 94], [255, 212, 163], [255, 236, 214]],
      'twilight-5': [[251, 187, 173], [238, 134, 149], [74, 122, 150], [51, 63, 88]]
    };

    let currentStream;
    const outputCanvas = document.getElementById('outputCanvas');
    const ctx = outputCanvas.getContext('2d');
    let targetWidth = 256;
    let pixelScale = 5;
    let selectedPalette = null;
    let brightnessFactor = 1.0;
    let contrastFactor = 1.3;
    let softFocusEnabled = false;

    // Reusable canvas for soft focus effect
    const fullSizeCanvas = document.createElement('canvas');
    const fullSizeCtx = fullSizeCanvas.getContext('2d');

    // Function to resize canvas to fill screen
    function resizeCanvas() {
      const windowWidth = window.innerWidth;
      const windowHeight = window.innerHeight;
      
      // Set canvas size to window size
      outputCanvas.width = windowWidth;
      outputCanvas.height = windowHeight;
    }

    // Add resize listener
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas(); // Initial resize

    async function initializeCamera(deviceId) {
      if (currentStream) currentStream.getTracks().forEach(track => track.stop());

      const constraints = {
        video: {
          deviceId: deviceId ? { exact: deviceId } : undefined,
          width: { ideal: 1280 },
          height: { ideal: 720 },
          facingMode: deviceId ? undefined : 'user'
        }
      };

      try {
        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        const video = document.createElement('video');
        video.srcObject = currentStream;
        await video.play();

        processVideo(video);
      } catch (error) {
        console.error('Error accessing camera:', error);
      }
    }

    function processVideo(video) {
      const processFrame = () => {
        if (video.videoWidth === 0) return;

        // Calculate scaling to fill screen while maintaining aspect ratio
        const videoAspect = video.videoWidth / video.videoHeight;
        const canvasAspect = outputCanvas.width / outputCanvas.height;
        
        let drawWidth, drawHeight, offsetX = 0, offsetY = 0;
        
        if (videoAspect > canvasAspect) {
          // Video is wider than canvas
          drawHeight = outputCanvas.height;
          drawWidth = drawHeight * videoAspect;
          offsetX = -(drawWidth - outputCanvas.width) / 2;
        } else {
          // Video is taller than canvas
          drawWidth = outputCanvas.width;
          drawHeight = drawWidth / videoAspect;
          offsetY = -(drawHeight - outputCanvas.height) / 2;
        }

        const tempCanvas = document.createElement('canvas');
        const tempCtx = tempCanvas.getContext('2d');
        tempCanvas.width = targetWidth;
        tempCanvas.height = Math.round(targetWidth / videoAspect);

        // Apply soft focus if enabled
        if (softFocusEnabled) {
          fullSizeCanvas.width = video.videoWidth;
          fullSizeCanvas.height = video.videoHeight;
          fullSizeCtx.filter = 'blur(1.5px)';
          fullSizeCtx.drawImage(video, 0, 0);
          tempCtx.drawImage(fullSizeCanvas, 0, 0, tempCanvas.width, tempCanvas.height);
        } else {
          tempCtx.drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height);
        }

        // Apply brightness/contrast
        const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
        const data = imageData.data;

        for (let i = 0; i < data.length; i += 4) {
          // Brightness
          let r = data[i] * brightnessFactor;
          let g = data[i + 1] * brightnessFactor;
          let b = data[i + 2] * brightnessFactor;

          // Contrast
          r = (r - 128) * contrastFactor + 128;
          g = (g - 128) * contrastFactor + 128;
          b = (b - 128) * contrastFactor + 128;

          // Clamp values
          data[i] = Math.min(255, Math.max(0, r));
          data[i + 1] = Math.min(255, Math.max(0, g));
          data[i + 2] = Math.min(255, Math.max(0, b));
        }

        // Quantize colors
        quantizeColors(data, selectedPalette);
        tempCtx.putImageData(imageData, 0, 0);

        // Clear canvas and draw the processed frame
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, outputCanvas.width, outputCanvas.height);
        
        ctx.imageSmoothingEnabled = false;
        ctx.drawImage(tempCanvas, offsetX, offsetY, drawWidth, drawHeight);

        requestAnimationFrame(processFrame);
      };
      processFrame();
    }

    function quantizeColors(data, palette) {
      for (let i = 0; i < data.length; i += 4) {
        let r = data[i];
        let g = data[i + 1];
        let b = data[i + 2];

        if (palette) {
          let minDist = Infinity;
          let closestColor = palette[0];
          for (const color of palette) {
            const dist = Math.sqrt(
              Math.pow(color[0] - r, 2) +
              Math.pow(color[1] - g, 2) +
              Math.pow(color[2] - b, 2)
            );
            if (dist < minDist) {
              minDist = dist;
              closestColor = color;
            }
          }
          data[i] = closestColor[0];
          data[i + 1] = closestColor[1];
          data[i + 2] = closestColor[2];
        } else {
          // Uniform quantization (64 colors)
          r = Math.round(r / 85) * 85;
          g = Math.round(g / 85) * 85;
          b = Math.round(b / 85) * 85;
          data[i] = Math.min(r, 255);
          data[i + 1] = Math.min(g, 255);
          data[i + 2] = Math.min(b, 255);
        }
      }
    }

    // Camera selection handling
    async function populateCameras() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const videoDevices = devices.filter(device => device.kind === 'videoinput');
      const select = document.getElementById('cameraSelect');

      select.innerHTML = videoDevices
        .map(device => `<option value="${device.deviceId}">${device.label || 'Camera'}</option>`)
        .join('');

      select.addEventListener('change', () => initializeCamera(select.value));
    }

    // Palette selection handling
    function populatePalettes() {
      const select = document.getElementById('paletteSelect');
      select.innerHTML = '<option value="none">no palette</option>' +
        Object.keys(palettes)
          .map(name => `<option value="${name}">${name}</option>`)
          .join('');

      select.addEventListener('change', () => {
        selectedPalette = select.value === 'none' ? null : palettes[select.value];
      });
    }

    document.getElementById('pixelSize').addEventListener('input', (e) => {
      pixelScale = parseInt(e.target.value);
      targetWidth = Math.max(16, Math.floor(window.innerWidth / pixelScale));
    });

    document.getElementById('brightness').addEventListener('input', (e) => {
      brightnessFactor = parseFloat(e.target.value);
    });

    document.getElementById('contrast').addEventListener('input', (e) => {
      contrastFactor = parseFloat(e.target.value);
    });

    // Initialize
    populatePalettes();
    populateCameras();
    initializeCamera();

    // Handle camera changes
    navigator.mediaDevices.addEventListener('devicechange', populateCameras);

    document.getElementById('captureButton').addEventListener('click', () => {
      const canvas = document.getElementById('outputCanvas');
      const link = document.createElement('a');
      link.href = canvas.toDataURL('image/png');
      link.download = 'captured_image.png';
      link.click();
    });

    // Add soft focus toggle handler
    document.getElementById('softFocusToggle').addEventListener('change', function (e) {
      softFocusEnabled = e.target.checked;
    });
  </script>
</body>
</html>